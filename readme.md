## CS205 C/C++ Programming
### Project 2 A Better Calculator
#### Name: 程司哲
#### Sid: 12112104
___

### 项目简介：

本项目实现了一个可以自动识别表达式并完成数学运算的计算器。该计算器支持复杂的带括号的加减乘除表达式运算。除此之外，还支持给变量赋值。程序能自动区分赋值语句和运算语句，并且在输出中体现出来。分别为："Assigned Successfully!" 和 "Solution:..." 。在运算语句中，输入的信息会被程序自动标准格式化。 最后，程序支持两个数学函数操作，分别为abs取绝对值，sqrt开根号。开根号使用二分法配合自己实现的乘法重载实现。

### Part 1: Analysis
需求：实现一个可以完成更多功能的计算器。

1. 输入表达式时可以得出结果，如 $2+3$， $5+2*3$等
2. 支持括号描述优先级，如 $(5+2)*3$
3. 支持定义变量，如 $x=3$
4. 支持数学函数，如 $sqrt(3)$
5. 支持高精度，如 $9999999999999999999.222222222+1.11$

### Part 2: Code
关键部分代码（利用结构体存储Number类）：

```
    int errorCode = 0;//0: no error 1: length error 2: type error
    // intPart: higher digit has higher index
    // fracPart: higher digit has lower index
    // this is in order to process digital carrying easier
    // 12.45: intPart:{2,1} fracPart:{4,5} 
    int intPart[maxLen + 10], fracPart[maxLen + 10], numSign = 1;
    int intLen = 0, fracLen = 0;
}
```

### Part 3: Result& Verification

**基本功能1之加减：**
```
Case 1:
Input: 2+3
Output: 2 + 3 = 5
Input2: 2-3
Output: 2 - 3 = -1

```
**基本功能2之复合运算：**
```
Case 2:
Input: 5+2*3
Output: 5 + 2 * 3 = 11

```
**基本功能3之括号优先级**
```
Case 3:
Input: (5+2)*3
Output: (5 + 2) * 3 = 21
Input2: 5+(2*3)
Output2: 5 + (2 * 3) = 11
Input3: (5+2)*3+5+2*3
Output3: (5 + 2) * 3 + 5 + 2 * 3 = 32
```
**拓展功能1之变量赋值与运算**
```
Case 4:
Input1: x=3
Output1: Assigned Successfully!
Input2: x*5+3
Output2: x * 5 + 3 = 18
Input3: x=7
Output3: Assigned Successfully!
Input4: (x+x)*x
Output4: (x + x) * x = 98

```
**拓展功能2之数学函数**

```
Input1: sqrt(5)
Output1: sqrt(5) = 2.23
Input2: sqrt(4)
Output2: sqrt(4) = 2
Input3: sqrt((2+3)*2)
Output3: sqrt((2 + 3) * 2) = 3.16
Input4: abs(-23.232323)
Output4: abs( - 23.232323) = 23.232323
Input5: sqrt(1e6)
Output5: sqrt(1e6) = 1000

```
**拓展功能3之高精度**

```
Input1: 100000000000000000000000000000.22222222222222222222+200000000000000000000000000000.111111111
Output1: 100000000000000000000000000000.22222222222222222222 + 200000000000000000000000000000.111111111 = 300000000000000000000000000000.33333333322222222222
Input2: sqrt(1e100)
Output2: sqrt(1e100) = 100000000000000000000000000000000000000000000000000

```
**异常处理**

```
Input1: 1e888*1e888
Output1: Error occurred! Please examine your typing
//最多支持整数，小数各1000位运算
Input2: 3+3=6
Output2: This var name is illegel!
Input3: x=aaa
Output3: Can not assign this value!
Input4: sqrt(-1)
Output4: Error occurred! Please examine your typing
//暂时不支持复数运算，故报出异常
Input5: a=1=1
Output5: You are typing a wrong equation!
```

**标准格式化**

```
Input1: 1     +      1
Output1: 1 + 1 = 2
Input2: sqrt  (  1  +   1  )
Output2: sqrt(1 + 1) = 1.41
```

### Part 4: Difficulties & Solutions

#### **如何实现基本的加减乘除优先级操作？**

对于没有括号的表达式，表达式为$$a*b*c+d*e*f+...$这样的Sum of Products格式（加减号可以互换，乘除号可以互换）。于是，对于没有括号的式子，我们可以想到通过加减号将式子分隔开，然后用另一个函数处理仅有乘除的式子。

#### **如何加入括号处理？**

首先，对于最外层就是括号的式子，我们可以直接将括号去掉而不影响结果。接下来，仍然向上一问中一样以**括号外的**加减号分隔式子。但在将分隔后的式子按乘除分解时，我们可以注意到这里不仅是乘除，还有可能是括号表达式。所以，我们检验它是否是括号表达式。如果是的话就递归地放进处理式子的函数进行处理。如果不是的话像上一问一样通过乘除分隔开。如果乘除分隔的时候遇到括号表达式也同理，递归地去处理。

#### **如何实现高精度加减乘除？**

**高精度乘法**在$Project1$中已经实现。简而言之就是用数组来储存整数和小数部分的每一位数，然后将每一位分隔开相乘，加到对应的数位上去。

**高精度加法**相对更加简单，直接将每一位相加，超过10的部分进位到下一位即可。但需要特别注意的是加上负数的情况。我们预先重载一个小于运算符，按符号，位数，每一位的数字为顺序比较两个$Number$ 的大小。在处理完后，对于 $a+b$，若 $a+b>0$ 即 $a>(-b)$ ，我们之间相加即可。若中间出现负数，将其+10并且高位-1，做一个反过来的进位操作。因为我们已知答案是正数，所以最终一定会加到一个正数的最高位。若 $a+b<0$ ，我们将每一位反转，然后类似地进行操作，最后把答案的符号反转即可。

**高精度减法**在实现了加法的前提下非常简单，a-b即为a+(-b)，只需要将b的 $Sign$ 反转后加a

**高精度除法**采用了类似试除法的方法。不同的是，其核心在于不断相减。我们将除数乘以$10^n$让其和被除数位数一样，然后不断地让被除数减去该数并且答案加 $10^n$ ，直到被除数小于除数为止。到这一步后，我们将被除数除以10并且重复刚才的过程，直到精度达到我们的要求（设定为被除数与除数有效数字更高的一个再+2）

#### **如何实现变量赋值？**

检测有一个等号的式子，通过等号分隔开，左边为变量，右边为值，装进一个<string, Number>的map即可。接下来的过程中若遇到map内的字符串就直接返回对应的Number。

#### **异常处理怎么实现？**

在我们递归到最底层即没有括号和运算符的时候，判断是否是一个数字即可。值得注意的是，这次的计算器兼容了Simple Calculator的功能，即$1e5$这样的表达式会被识别为一个数字。另外，检查左右括号是否匹配。
对于变量赋值的异常，首先我们检测等号是否是一个，接下来检测是否满足变量命名要求，如首字符不能是数字，不能是保留字（quit），不能含有+，-等符号等。

